# GitHub Actions CI/CD Pipeline for Automobile Service Booking System
# Automatically builds and tests the application on push to main branch
name: CI/CD Pipeline

# Trigger the workflow on push to main branch and pull requests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Define jobs to run
jobs:
  # Build and test job
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout the repository code
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # Step 2: Set up Docker Buildx for advanced Docker features
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    # Step 3: Log in to Docker Hub (optional, for pushing images)
    # Uncomment and add secrets if you want to push to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
         username: ${{ secrets.DOCKER_USERNAME }}
         password: ${{ secrets.DOCKER_PASSWORD }}
    
    # Step 4: Build Docker images
    - name: Build Docker images
      run: |
        echo "üèóÔ∏è Building frontend Docker image..."
        docker build -t automobile-frontend ./client
        
        echo "üèóÔ∏è Building backend Docker image..."
        docker build -t automobile-backend ./server
        
        echo "‚úÖ Docker images built successfully"
    
    # Step 5: Start services with Docker Compose
    - name: Start services with Docker Compose
      run: |
        echo "üöÄ Starting services with Docker Compose..."
        docker-compose up -d
        
        echo "‚è≥ Waiting for services to be ready..."
        sleep 30
        
        echo "üîç Checking service status..."
        docker-compose ps
    
    # Step 6: Run health checks
    - name: Run health checks
      run: |
        echo "üè• Running health checks..."
        
        # Check backend health
        echo "Checking backend health..."
        curl -f http://localhost:5000/api/health || exit 1
        
        # Check frontend accessibility
        echo "Checking frontend accessibility..."
        curl -f http://localhost:3000 || exit 1
        
        echo "‚úÖ All health checks passed"
    
    # Step 7: Run basic API tests
    - name: Test API endpoints
      run: |
        echo "üß™ Testing API endpoints..."
        
        # Test POST /api/bookings
        echo "Testing booking creation..."
        curl -X POST http://localhost:5000/api/bookings \
          -H "Content-Type: application/json" \
          -d '{"name":"Test User","vehicle":"TEST-123","service":"Oil Change"}' \
          -f || exit 1
        
        # Test GET /api/bookings
        echo "Testing booking retrieval..."
        curl -f http://localhost:5000/api/bookings || exit 1
        
        echo "‚úÖ API tests passed"
    
    # Step 8: Show container logs for debugging
    - name: Show container logs
      if: failure()
      run: |
        echo "üìã Container logs for debugging..."
        docker-compose logs --tail=50
    
    # Step 9: Clean up
    - name: Clean up
      if: always()
      run: |
        echo "üßπ Cleaning up..."
        docker-compose down -v
        docker system prune -f
        
        echo "‚úÖ Cleanup completed"

  # Optional: Deploy job (runs only on main branch)
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Deploy notification
      run: |
        echo "üöÄ Deployment would happen here"
        echo "This is where you would deploy to your production environment"
        echo "Examples: AWS ECS, Kubernetes, Docker Swarm, etc."